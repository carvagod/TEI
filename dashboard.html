<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Usuario</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f4f9;
            margin: 0;
            padding: 20px;
            text-align: center;
        }
        header {
            background: #6200ea;
            color: #fff;
            padding: 1rem;
        }
        h1 {
            color: #6200ea;
        }
        footer {
            background: #333;
            color: #fff;
            padding: 1rem;
            position: relative; /* Ajustar para permitir espacio extra */
            width: 100%;
        }
        .table-container {
            overflow: auto; /* Scroll horizontal y vertical */
            max-height: 300px; /* Altura máxima para la tabla */
            max-width: 80%; /* Ancho máximo de la tabla */
            margin: 20px auto;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #fff;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            text-align: center;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
        }
        th {
            background-color: #6200ea;
            color: #fff;
        }
        td {
            min-height: 40px; /* Reducir altura mínima de las celdas */
            font-size: 14px; /* Reducir tamaño de fuente */
        }
        .spacing {
            height: 100px; /* Espaciado adicional debajo de la tabla */
        }
    </style>
</head>
<body>
    <header>
        <h1>Bienvenido, <span id="userName"></span>!</h1>
    </header>
    <p>Aquí puedes gestionar tus horarios y tareas pendientes.</p>
    
    <!-- Contenedor para la tabla -->
    <div id="tableContainer" class="table-container"></div>

    <!-- Espaciado adicional debajo de la tabla -->
    <div class="spacing"></div>
    <footer>
        <p>&copy; 2024 Gestión de Horarios. Todos los derechos reservados.</p>
    </footer>

    <script>
        const params = new URLSearchParams(window.location.search);
        const userName = params.get("name");
        const userId = params.get("userId");
        const horariosCsvUrl = "https://raw.githubusercontent.com/carvagod/TEI/refs/heads/main/horarios.csv"; // Enlace RAW del CSV de horarios

        if (userName) {
            document.getElementById("userName").textContent = decodeURIComponent(userName);

            // Función para crear la tabla vacía
            function crearTablaHorarios() {
                const table = document.createElement("table");

                // Crear encabezados (días de la semana)
                const headerRow = document.createElement("tr");
                const emptyCell = document.createElement("th");
                emptyCell.textContent = "Bloque";
                headerRow.appendChild(emptyCell);

                const diasSemana = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado", "Domingo"];
                diasSemana.forEach(dia => {
                    const th = document.createElement("th");
                    th.textContent = dia;
                    headerRow.appendChild(th);
                });

                table.appendChild(headerRow);

                // Crear filas de bloques (1-12)
                for (let i = 1; i <= 12; i++) {
                    const row = document.createElement("tr");

                    // Primera celda: número del bloque
                    const blockCell = document.createElement("td");
                    blockCell.textContent = i;
                    row.appendChild(blockCell);

                    // Celdas vacías para cada día
                    for (let j = 0; j < diasSemana.length; j++) {
                        const cell = document.createElement("td");
                        row.appendChild(cell);
                    }

                    table.appendChild(row);
                }

                return table;
            }

            // Función para llenar la tabla con datos del CSV
            function llenarTablaHorarios(table, horarios) {
                const rows = table.querySelectorAll("tr");
                const diasSemana = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado", "Domingo"];
        
                horarios.forEach(horario => {
                    const [id, ramo, seccion, ...horariosBloques] = horario.split(",");
                    if (id.trim() !== userId) return; // Verificar si el ID coincide con el usuario
        
                    for (let i = 0; i < horariosBloques.length; i += 2) {
                        const dia = horariosBloques[i]?.trim();
                        const bloque = parseInt(horariosBloques[i + 1]?.trim(), 10);
        
                        if (dia && bloque && diasSemana.includes(dia)) {
                            const diaIndex = diasSemana.indexOf(dia) + 1; // +1 porque la primera columna es el número de bloque
                            const cell = rows[bloque].children[diaIndex];
        
                            const contenido = `${ramo} (Sección ${seccion})`;
                            if (cell.textContent.trim()) {
                                cell.textContent += ` // ${contenido}`;
                            } else {
                                cell.textContent = contenido;
                            }
                        }
                    }
                });
            }

            // Cargar datos del CSV y generar la tabla
            fetch(horariosCsvUrl)
                .then(response => {
                    if (!response.ok) throw new Error("Error al cargar los datos del CSV.");
                    return response.text();
                })
                .then(data => {
                    const horarios = data.split("\n").slice(1).filter(row => row); // Omitir encabezados y filas vacías

                    const tableContainer = document.getElementById("tableContainer");
                    const table = crearTablaHorarios();
                    llenarTablaHorarios(table, horarios);
                    tableContainer.appendChild(table);
                })
                .catch(error => {
                    console.error(error);
                    document.body.innerHTML += "<p>Error al cargar los horarios. Intenta más tarde.</p>";
                });
        } else {
            document.body.innerHTML = "<h1>Acceso denegado. Inicia sesión primero.</h1>";
        }
    </script>
</body>
</html>
